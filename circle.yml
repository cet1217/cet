machine:
  services:
    - docker

dependencies:
  cache_directories:
    - "~/.cetash" # Cache the cetash DAG generated by hive for consecutive builds
    - "~/.docker" # Cache all docker images manually to avoid lengthy rebuilds
  override:
    # Restore all previously cached docker images
    - mkdir -p ~/.docker
    - for img in `ls ~/.docker`; do docker load -i ~/.docker/$img; done

    # Pull in and hive, restore cached cetash DAGs and do a dry run
    - go get -u github.com/karalabe/hive
    - (cd ~/.go_workspace/src/github.com/karalabe/hive && mkdir -p workspace/cetash/ ~/.cetash)
    - (cd ~/.go_workspace/src/github.com/karalabe/hive && cp -r ~/.cetash/. workspace/cetash/)
    - (cd ~/.go_workspace/src/github.com/karalabe/hive && hive --docker-noshell --client=NONE --test=. --sim=. --loglevel=6)
    # Generating DAG
    - (cd ~/cetereumj && ./gradlew run -PmainClass=org.cetereum.Start -PjvmArgs="-Dcetash.dir=~/.go_workspace/src/github.com/karalabe/hive/workspace/cetash -Dcetash.blockNumber=0 -Xmx2G")
    # timeout 20 min
    - (cd ~/.go_workspace/src/github.com/karalabe/hive && hive --docker-noshell --client=cetereumj:local --test=NONE --sim=NONE --loglevel=6):
        timeout: 1200

    # Cache all the docker images and the cetash DAGs
    - for img in `docker images | grep -v "^<none>" | tail -n +2 | awk '{print $1}'`; do docker save $img > ~/.docker/`echo $img | tr '/' ':'`.tar; done
    - cp -r ~/.go_workspace/src/github.com/karalabe/hive/workspace/cetash/. ~/.cetash
    # Cache gradle artifacts
    - (cd ~/cetereumj && ./gradlew compileJava)
    - (cd ~ && git clone --depth 1 -b develop https://github.com/ceter-camp/cetereum-harmony.git)
    - (cd ~/cetereum-harmony && ./gradlew dependencyManagement)

test:
  override:
    # Build app and move into a known folder
    - (cd ~/.go_workspace/src/github.com/karalabe/hive/clients/cetereumj\:local && ./build.sh ~/cetereumj ~/cetereum-harmony ~)

    # Run hive and move all generated logs into the public artifacts folder
    - (cd ~/.go_workspace/src/github.com/karalabe/hive && hive --docker-noshell --client=cetereumj:local --override=$HOME/harmony.ceter.camp.tar --smoke --loglevel=3):
        timeout: 4000
    - (cd ~/.go_workspace/src/github.com/karalabe/hive && hive --docker-noshell --client=cetereumj:local --override=$HOME/harmony.ceter.camp.tar  --test=. --loglevel=3):
        timeout: 4000
    - cp -r ~/.go_workspace/src/github.com/karalabe/hive/workspace/logs/* $CIRCLE_ARTIFACTS

